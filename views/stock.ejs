<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jusik Game</title>
    <link rel="stylesheet" href="/main.css">
    <link rel="stylesheet" href="/list.css">
    <link rel="stylesheet" href="/graph.css">
    <style>
      .stock-info {
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
        gap: 10px;
      }

      .user-list {
        width: 30vw;
        text-align: center;
        overflow: auto;
      }

    </style>
  </head>
  <body>
    <%- include("./nav.ejs") %>
    <main>
      <h1><%= stock.name %></h1>
      <h2 class="price"><%= stock.currentPrice %>C</h2>
      <div class="stock-info">
        <div class="graph">
          <canvas></canvas>
          <div class="point-value"></div>
        </div>
        <div class="user-list">
          <h1>주식 보유자 목록</h1>
          <ul>
            <% for (let user of stock.users) { %>
            <li>
              <span><%= user.username %></span>
              <span><%= user.quantity %>주</span>
            </li>
            <% } %>
          </ul>
        </div>
      </div>
      <% if (loggedUser) { %>
      <p>
        <button id="buy">구매</button>
        <button id="sell">판매</button>
      </p>
      <% } %>
    </main>

    <script src="https://kit.fontawesome.com/e217a51301.js" crossorigin="anonymous"></script>
    <script>
      const buyButton = document.getElementById("buy");
      const sellButton = document.getElementById("sell");
      const stockId = new URLSearchParams(location.search).get("stockId");

      async function buy() {
        const quantity = prompt("몆 주를 구매하시겠습니까?");
        if (isNaN(Number(quantity))) {
          alert("숫자로 입력해 주세요.");
          return;
        }

        const res = await fetch("/stock/buy", {
          method: "post",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            quantity,
            stockId
          })
        });

        if (res.status !== 200) {
          const {
            message
          } = await res.json();
          alert(message);
          return;
        }

        alert("구매하였습니다.");
        location.reload();
      }

      async function sell() {
        const quantity = prompt("몆 주를 판매하시겠습니까?");
        if (isNaN(Number(quantity))) {
          alert("숫자로 입력해 주세요.");
          return;
        }

        const res = await fetch("/stock/sell", {
          method: "post",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            quantity,
            stockId
          })
        });

        if (res.status !== 200) {
          const {
            message
          } = await res.json();
          alert(message);
          return;
        }

        alert("판매하였습니다.");
        location.reload();
      }

      buyButton?.addEventListener("click", buy);
      sellButton?.addEventListener("click", sell);

      const array = JSON.parse("[<%= stock.priceHistory %>]");
      array.push(Number("<%= stock.currentPrice %>"));

    </script>
    <script src="/graph.js"></script>
    <script>
      function resizeList() {
        document.querySelector(".user-list").style.height = canvas.height + "px";
      }

      canvas.addEventListener("resize", resizeList);
      resizeList();

    </script>
  </body>
</html>
